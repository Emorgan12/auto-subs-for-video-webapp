{% extends 'web_app_auto_subs/base.html' %}

{% block content %}
    {% if not perms.auth.social_auth %}
        <a href="{% url 'edit_profile' %}" class="edit-profile-link">Изменить пользовательские данные</a>
    {% endif %}

    <br><br><br>

    <div id="progressContainer">
        {% for video in videos %}
            <div class="video-item" data-video-pk="{{ video.pk }}">
                <a href="{{ video.get_absolute_url }}">{{ video.pk }}: {{ video.name_of_video }}</a>
                <br>
                <br>
                
                <div class="progressBar">
                    <div>Процесс транскрипции: <span id="whisperText{{ video.pk }}">0%</span></div>
                    <span id="whisperProgress{{ video.pk }}" style="display: block; height: 20px; background: #4caf50; border-radius: 5px; width: 0;" data-whisper-progress="0"></span>
                </div>

                <div class="progressBar">
                    <div>Прогресс перевода: <span id="translateText{{ video.pk }}">0%</span></div>
                    <span id="translateProgress{{ video.pk }}" style="display: block; height: 20px; background: #4caf50; border-radius: 5px; width: 0;" data-translate-progress="0"></span>
                </div>

                <div class="progressBar">
                    <div>Рендеринг: <span id="moviepyText{{ video.pk }}">0%</span></div>
                    <span id="moviepyProgress{{ video.pk }}" style="display: block; height: 20px; background: #4caf50; border-radius: 5px; width: 0;" data-moviepy-progress="0"></span>
                </div>
                
                <br>
            </div>
        {% endfor %}
    </div>

    <br>
    <br>
    <br>
    
    <nav>
        <ul class="D">
            {% if page_obj.has_previous %}
                <li><a href="?page={{ page_obj.previous_page_number }}">&lt;</a></li>
            {% endif %}

            {% for p in paginator.page_range %}
                {% if page_obj.number == p %}
                    <li><span class="current curr">{{ p }}</span></li>
                {% elif p >= page_obj.number|add:-5 and p <= page_obj.number|add:5 %}
                    <li><a href="?page={{ p }}">{{ p }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li><a href="?page={{ page_obj.next_page_number }}">&gt;</a></li>
            {% endif %}
        </ul>
    </nav>

    <script>
        // Создаем пустой массив для хранения значений video.pk
        const videoPKs = [];

        // Получаем все элементы с классом "video-item"
        const videoItems = document.querySelectorAll('.video-item');

        // Проходим по каждому элементу и получаем значение атрибута data-video-pk
        videoItems.forEach(item => {
            const pk = item.getAttribute('data-video-pk');
            videoPKs.push(pk); // Сохраняем значение pk в массив
        });

        // Теперь массив videoPKs содержит все значения video.pk
        console.log(videoPKs);

    </script>

    <script>
        $(document).ready(function() {
            // Функция для выполнения AJAX-запросов и обновления прогресса
            function updateProgress() {
                // Получаем все элементы с классом "video-item"
                const videoItems = document.querySelectorAll('.video-item');
        
                // Проходим по каждому элементу
                videoItems.forEach(item => {
                    const videoPk = item.getAttribute('data-video-pk'); // Получаем значение video.pk
    
                    // Получаем текущее значение прогресса из атрибутов
                    const moviepyProgress = parseInt($(`#moviepyProgress${videoPk}`).attr('data-moviepy-progress')) || 0;
                    const whisperProgress = parseInt($(`#whisperProgress${videoPk}`).attr('data-whisper-progress')) || 0;
                    const translateProgress = parseInt($(`#translateProgress${videoPk}`).attr('data-translate-progress')) || 0; // Добавлено для перевода
                    
                    // Логируем текущие значения прогресса для отладки
                    console.log(`Видео ID: ${videoPk}, MoviePy Progress: ${moviepyProgress}, Whisper Progress: ${whisperProgress}, Translate Progress: ${translateProgress}`);
    
                    // Проверяем прогресс, если он не равен 100, отправляем запрос
                    if (moviepyProgress < 100 || whisperProgress < 100 || translateProgress < 100) {
                        // AJAX-запрос для получения прогресса
                        $.ajax({
                            url: `http://localhost:8000/progress_bar/?video_id=${videoPk}`,
                            type: 'GET',
                            success: function(response) {
                                // Логируем ответ сервера для отладки
                                console.log(`Ответ сервера для видео ${response.video_id}:`, response);
    
                                // Обновляем значения прогресса на странице
                                if (response.moviepy_progress !== null) {
                                    $(`#moviepyProgress${response.video_id}`).css('width', response.moviepy_progress + '%');
                                    $(`#moviepyProgress${response.video_id}`).attr('data-moviepy-progress', response.moviepy_progress); // обновляем атрибут
                                    $(`#moviepyText${response.video_id}`).text(response.moviepy_progress + '%');
                                }
    
                                if (response.whisper_progress !== null) {
                                    $(`#whisperProgress${response.video_id}`).css('width', response.whisper_progress + '%');
                                    $(`#whisperProgress${response.video_id}`).attr('data-whisper-progress', response.whisper_progress); // обновляем атрибут
                                    $(`#whisperText${response.video_id}`).text(response.whisper_progress + '%');
                                }
    
                                if (response.translate_progress !== null) {
                                    $(`#translateProgress${response.video_id}`).css('width', response.translate_progress + '%');
                                    $(`#translateProgress${response.video_id}`).attr('data-translate-progress', response.translate_progress); // обновляем атрибут
                                    $(`#translateText${response.video_id}`).text(response.translate_progress + '%');
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Ошибка при выполнении запроса:', error);
                            }
                        });
                    }
                });
            }
        
            // Выполняем первый запрос сразу при загрузке страницы
            updateProgress();
        
            // Устанавливаем интервал для выполнения запроса каждые 5 секунд (5000 мс)
            setInterval(updateProgress, 5000);
        });
    </script>
{% endblock content %}
