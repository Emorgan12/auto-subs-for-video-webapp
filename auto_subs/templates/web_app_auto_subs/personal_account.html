{% extends 'web_app_auto_subs/base.html' %}

{% block content %}
    <a href="{% url 'edit_profile' %}" class="edit-profile-link">Изменить пользовательские данные</a>

    <br><br><br>

    <div id="progressContainer">
        {% for video in videos %}
            <div class="video-item" data-video-pk="{{ video.pk }}">
                <a href="{{ video.get_absolute_url }}">{{ video.pk }}: {{ video.name_of_video }}</a>
                <br>
                <br>
                <div class="progressBar">
                    <div>Процесс транскрипции: <span id="whisperText{{ video.pk }}">0%</span></div>
                    <span id="whisperProgress{{ video.pk }}" style="display: block; height: 20px; background: #4caf50; border-radius: 5px; width: 0;"></span>
                </div>
                <div class="progressBar">
                    <div>Рендеринг: <span id="moviepyText{{ video.pk }}">0%</span></div>
                    <span id="moviepyProgress{{ video.pk }}" style="display: block; height: 20px; background: #4caf50; border-radius: 5px; width: 0;"></span>
                </div>
                
                <br>
            </div>
        {% endfor %}
    </div>

    <br>
    <br>
    <br>
    
    <nav>
        <ul class="D">
            {% if page_obj.has_previous %}
                <li><a href="?page={{ page_obj.previous_page_number }}">&lt;</a></li>
            {% endif %}

            {% for p in paginator.page_range %}
                {% if page_obj.number == p %}
                    <li><span class="current curr">{{ p }}</span></li>
                {% elif p >= page_obj.number|add:-5 and p <= page_obj.number|add:5 %}
                    <li><a href="?page={{ p }}">{{ p }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li><a href="?page={{ page_obj.next_page_number }}">&gt;</a></li>
            {% endif %}
        </ul>
    </nav>

    <!-- JavaScript код -->
    <script>
        // Создаем пустой массив для хранения значений video.pk
        const videoPKs = [];

        // Получаем все элементы с классом "video-item"
        const videoItems = document.querySelectorAll('.video-item');

        // Проходим по каждому элементу и получаем значение атрибута data-video-pk
        videoItems.forEach(item => {
            const pk = item.getAttribute('data-video-pk');
            videoPKs.push(pk); // Сохраняем значение pk в массив
        });

        // Теперь массив videoPKs содержит все значения video.pk
        console.log(videoPKs);

    </script>

    <script>
        $(document).ready(function() {
            // Функция для выполнения AJAX-запросов и обновления прогресса
            function updateProgress() {
                // Получаем все элементы с классом "video-item"
                const videoItems = document.querySelectorAll('.video-item');
        
                // Проходим по каждому элементу
                videoItems.forEach(item => {
                    const videoPk = item.getAttribute('data-video-pk'); // Получаем значение video.pk
        
                    // AJAX-запрос для получения прогресса
                    $.ajax({
                        url: `http://localhost:8000/progress_bar/?video_id=${videoPk}`,
                        type: 'GET',
                        success: function(response) {
                            // Обновляем значения прогресса на странице
                            if (response.moviepy_progress !== null) {
                                $(`#moviepyProgress${response.video_id}`).css('width', response.moviepy_progress + '%');
                                $(`#moviepyText${response.video_id}`).text(response.moviepy_progress + '%');
                            }
        
                            if (response.whisper_progress !== null) {
                                $(`#whisperProgress${response.video_id}`).css('width', response.whisper_progress + '%');
                                $(`#whisperText${response.video_id}`).text(response.whisper_progress + '%');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Ошибка при выполнении запроса:', error);
                        }
                    });
                });
            }
        
            // Выполняем первый запрос сразу при загрузке страницы
            updateProgress();
        
            // Устанавливаем интервал для выполнения запроса каждые 5 секунд (5000 мс)
            setInterval(updateProgress, 5000);
        });
    </script>
        


{% endblock content %}
